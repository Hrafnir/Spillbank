<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokerkassa Fokus - Fiks v14 (Event Listener Debug)</title>
    <style>
        /* --- CSS (uendret) --- */
         :root { --bg-color: #000000; --bg-secondary-color: #1e1e1e; --text-color: #FFFFFF; --text-muted-color: #b0b0b0; --primary-color: #FFFF00; --success-color: #28a745; --danger-color: #dc3545; --warning-color: #FFD700; --border-color: #FFFF00; --input-bg: #333333; --input-border: #888888; --button-bg: #444444; --button-text: #FFFFFF; }
         body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.7; margin: 0; padding: 15px; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }
         .container { max-width: 900px; margin: 15px auto; background: var(--bg-secondary-color); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
         h1, h2 { color: var(--primary-color); text-align: center; margin-top: 0; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
         h1 { font-size: 2em; } h2 { font-size: 1.6em; }
         .section { margin-bottom: 35px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-secondary-color); } /* Gjelder ANDRE sections */
         button { padding: 12px 20px; border: 1px solid transparent; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.2s ease, transform 0.1s ease, border-color 0.2s; margin: 5px; background-color: var(--button-bg); color: var(--button-text);}
         button:hover:not(:disabled) { background-color: #555; } button:active { transform: translateY(1px); } button:disabled { cursor: not-allowed; opacity: 0.6; }
         .btn-primary { background-color: var(--primary-color); color: black; border-color: var(--primary-color); } .btn-primary:hover:not(:disabled) { background-color: #ffff66; border-color: #ffff66; } .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); } .btn-success:hover:not(:disabled) { background-color: #218838; border-color: #1e7e34;} .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); } .btn-danger:hover:not(:disabled) { background-color: #c82333; border-color: #bd2130; } .btn-warning { background-color: var(--warning-color); color: black; border-color: var(--warning-color); } .btn-warning:hover:not(:disabled) { background-color: #ffec80; border-color: #ffea6a; } .btn-secondary { background-color: #6c757d; color: white; border-color: #6c757d; } .btn-secondary:hover:not(:disabled) { background-color: #5a6268; border-color: #545b62;} .btn-small { padding: 5px 10px; font-size: 0.85em; } .btn-tiny { padding: 4px 8px; font-size: 0.9em; margin: 0 2px; line-height: 1; vertical-align: middle;}
         .purchase-decrement-btn, .purchase-increment-btn, .add-buyin-btn { background-color: var(--primary-color); color: black; border-color: var(--primary-color); } .purchase-decrement-btn:hover:not(:disabled), .purchase-increment-btn:hover:not(:disabled), .add-buyin-btn:hover:not(:disabled) { background-color: #ffff66; border-color: #ffff66; }
         .input-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; } .input-group label { flex-basis: 120px; font-weight: bold; color: var(--text-muted-color); } .input-group input[type="text"], .input-group input[type="number"], .input-group select { flex-grow: 1; padding: 10px; border: 1px solid var(--input-border); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color); font-size: 1em; min-width: 100px; } ::placeholder { color: var(--text-muted-color); opacity: 0.7; } input:focus, select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
         #player-list-section { border: none; padding: 0; background-color: transparent; margin-bottom: 35px; }
         #player-list-section h2 { /* Standard H2 styling */ }
         #add-player-fields { padding: 20px; margin-bottom: 30px; border: 3px solid var(--primary-color); border-radius: 8px; background-color: var(--bg-secondary-color); }
         ul#players { list-style: none; padding: 0; margin: 0; background-color: transparent; }
         li.player-item { border: 4px solid var(--primary-color); border-radius: 8px; padding: 25px; display: flex; flex-direction: column; gap: 15px; background-color: var(--bg-secondary-color); margin-bottom: 30px; box-shadow: none; transition: none; }
         .player-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
         .player-name { font-weight: bold; font-size: 1.5em; color: var(--primary-color); margin-right: 10px;}
         .player-status-text { font-style: italic; font-size: 1em; } .player-status-text.active { color: var(--warning-color); } .player-status-text.cashed_out { color: var(--text-muted-color); }
         .player-header .delete-btn { margin-left: auto; }
         .player-poker-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border-bottom: none; padding-bottom: 10px; margin-bottom: 10px; }
         .poker-control-group { display: flex; align-items: center; gap: 5px; } .poker-control-group label { font-size: 0.9em; color: var(--text-muted-color); } .poker-control-group .buyin-log { font-weight: normal; margin-left: 5px; color: var(--text-muted-color); font-size: 0.95em; } .poker-control-group .buyin-log .total-sum { font-weight: bold; color: var(--text-color); } .inline-edit-input { padding: 6px 8px; font-size: 0.95em; max-width: 100px; margin: 0; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 4px; text-align: right; } #player-list .player-result { font-weight: bold; font-size: 1.1em; margin-left: auto; } .result.win { color: var(--success-color); } .result.loss { color: var(--danger-color); } .result.neutral { color: var(--text-muted-color); } .result.win::before, .result.loss::before, .result.neutral::before { margin-right: 4px;} .result.win::before { content: "üí∞"; } .result.loss::before { content: "üí∏"; } .result.neutral::before { content: "üòê"; } .buyin-log-details { font-size: 0.9em; color: var(--text-muted-color); padding-left: 5px; }
         .player-purchases { padding-top: 5px; margin-top: 0px; font-size: 0.9em; color: var(--text-muted-color); border-top: none; } .player-purchases strong { color: var(--text-color); } .purchase-item { margin-right: 15px; display: inline-block; white-space: nowrap; margin-bottom: 5px;} .purchase-item .item-count { font-weight: bold; color: var(--text-color); margin: 0 3px;}
         .log-container { margin-top: 15px; } .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; } .transaction-log { display: none; margin-top: 5px; padding-top: 10px; font-size: 0.85em; color: var(--text-muted-color); } .transaction-log.visible { display: block; border-top: 1px dashed var(--input-border); } .transaction-log h4 { margin: 0; color: var(--text-muted-color); font-size: 1em; display: inline-block; margin-right: 10px; } .transaction-log ul { list-style: none; padding-left: 10px; margin: 0; } .transaction-log li { margin-bottom: 3px; } .transaction-log .log-time { font-weight: bold; margin-right: 8px; } .log-type-buyin { color: var(--success-color); } .log-type-cashout { color: var(--warning-color); } .log-type-item { color: var(--primary-color); opacity: 0.8; } .toggle-log-btn { margin-left: auto; }
         #item-config-list ul { list-style: none; padding: 0; } /* ... */
        .summary p { margin: 8px 0; font-size: 1.1em; } .summary .highlight { font-weight: bold; padding: 2px 6px; border-radius: 4px; } .summary .positive { color: var(--success-color); background-color: rgba(40, 167, 69, 0.1); } .summary .negative { color: var(--danger-color); background-color: rgba(220, 53, 69, 0.1); } .summary .neutral-sum { color: var(--text-muted-color); background-color: rgba(176, 176, 176, 0.1); }
         .output-area { white-space: pre-wrap; background-color: var(--input-bg); padding: 15px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; margin-bottom: 15px; max-height: 350px; overflow-y: auto; border: 1px solid var(--input-border); font-size: 1em; color: var(--text-color); min-height: 100px; width: 100%; box-sizing: border-box; } #plan-copy-feedback, #status-copy-feedback, #item-bill-copy-feedback { margin-left: 10px; font-style: italic; color: var(--success-color); } .action-buttons { text-align: center; margin-bottom: 15px;}
         #session-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background-color: var(--bg-secondary-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 1000; } #session-dialog::backdrop { background-color: rgba(0, 0, 0, 0.7); } #session-dialog h2 { margin-top: 0; color: var(--primary-color); } .dialog-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8em; color: var(--text-muted-color); cursor: pointer; padding: 0; line-height: 1;} .dialog-close-btn:hover { color: var(--text-color); } #session-dialog .session-controls, #session-dialog .session-load-area { margin-bottom: 15px; } #session-dialog .session-controls label, #session-dialog .session-load-area label { flex-basis: 100px; } #session-dialog .input-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; } #session-dialog .input-group label { flex-basis: 100px; color: var(--text-muted-color); } #session-dialog .input-group input, #session-dialog .input-group select { flex-grow: 1; padding: 8px; border: 1px solid var(--input-border); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color); font-size: 0.95em; min-width: 150px;} #session-dialog .action-buttons-grouped button { margin: 5px; } .toggle-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; justify-content: center; } .toggle-group label { flex-basis: auto; margin-bottom: 0; } .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; } .toggle-switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; } .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--primary-color); } input:checked + .slider:before { transform: translateX(26px); }
         #open-session-dialog-btn { position: absolute; top: 25px; right: 25px; z-index: 50; }
         .data-info { margin-top: 40px; background-color: var(--bg-secondary-color); border: 1px dashed var(--warning-color); } .data-info h2 { color: var(--warning-color); } .data-info p, .data-info ul { color: var(--text-muted-color); font-size: 0.95em; } .data-info strong { color: var(--warning-color); } .data-info code { background-color: var(--input-bg); padding: 2px 5px; border-radius: 3px; font-family: monospace;}
         #session-gate { text-align: center; padding: 40px 20px; border: 2px dashed var(--border-color); border-radius: 8px; margin: 30px auto; background-color: rgba(0,0,0,0.2); max-width: 600px; } #session-gate h2 { margin-bottom: 20px; color: var(--warning-color); border: none; }
         .main-content { display: none; } body.session-active .main-content { display: block; } body.session-active #session-gate { display: none; }
         @media (max-width: 768px) { /* ... */ } @media (max-width: 480px) { /* ... */ }
    </style>
</head>
<body class="">

<div class="container">
    <h1>Pokerkassa Fokus <span style="font-size: 0.7em; vertical-align: middle;">üÉèüçªüçïüíæ</span></h1>
    <button id="open-session-dialog-btn" class="btn-secondary">Start / Last Sesjon</button>

    <div id="session-gate">
        <h2>Velkommen til Pokerkassa!</h2> <p>For √• begynne, m√• du enten starte en ny sesjon eller laste en eksisterende.</p> <p>Bruk knappen "Start / Last Sesjon" oppe til h√∏yre.</p>
    </div>

    <div class="main-content">
        <div id="player-list-section">
            <h2>Spillere & Varekj√∏p</h2>
            <div id="add-player-fields">
                 <h3 style="margin-top:0; margin-bottom: 10px; color: var(--text-muted-color); font-size: 1.1em;">Legg til Ny Spiller</h3> <div class="input-group"> <label for="player-name">Navn:</label> <input type="text" id="player-name" placeholder="Spillernavn"> </div> <div class="input-group"> <label for="initial-buy-in">F√∏rste Innkj√∏p:</label> <input type="number" id="initial-buy-in" placeholder="Sum (kan st√• tom)"> </div> <div style="text-align: right;"> <button id="add-player-btn" class="btn-primary">Legg til Spiller</button> </div>
            </div>
            <ul id="players"></ul>
        </div>
        <div class="section item-config"><h2>Vareadministrasjon</h2> <div id="item-config-form" class="input-form" style="background: transparent; border: none; padding: 0;"> <div class="input-group"> <label for="item-name">Ny Vare:</label> <input type="text" id="item-name" placeholder="Navn p√• vare"> </div> <div class="input-group"> <label for="item-price">Pris (kr):</label> <input type="number" id="item-price" placeholder="Pris per enhet"> </div> <div style="text-align: right;"> <button id="add-item-btn" class="btn-primary">Legg til Vare</button> </div> </div> <div id="item-config-list" style="margin-top: 20px;"> <h3>Definerte Varer:</h3> <ul></ul> </div> </div>
        <div class="summary section"><h2>Oppgj√∏rsstatus (Live)</h2> <p>Totalt Innkj√∏p (Poker): <span id="total-player-buy-in" class="highlight neutral-sum">0</span> kr</p> <p>Totalt Uttak (Poker): <span id="total-player-cash-out" class="highlight neutral-sum">0</span> kr</p> <p><strong>Husets Pokerresultat:</strong> <span id="house-poker-result" class="highlight">0</span> kr</p> <hr style="border-color: var(--input-border); opacity: 0.5; margin: 15px 0;"> <p><strong>Total Innkj√∏p Varesalg:</strong> <span id="total-item-revenue" class="highlight positive">0</span> kr</p> <hr style="border-color: var(--input-border); opacity: 0.5; margin: 15px 0;"> <p>St√∏rste Gevinst (Poker Ute): <span id="biggest-win" class="highlight positive">Ingen</span></p> <p>St√∏rste Tap (Poker Ute): <span id="biggest-loss" class="highlight negative">Ingen</span></p> <p>Antall spillere inne: <span id="active-players-count" class="highlight neutral-sum">0</span></p> </div>
        <div class="item-billing section"> <h2>Mat & Drikke Oppgj√∏r (Separat)</h2> <div class="action-buttons"> <button id="generate-item-bill-btn" class="btn-secondary">Generer Liste over Kj√∏p</button> </div> <textarea id="item-bill-output" class="output-area" readonly placeholder="Trykk 'Generer Liste...'"></textarea> <div style="text-align: right; margin-top: 5px;"> <button id="copy-item-bill-btn" class="btn-primary" style="display: none;">Kopier Liste</button> <span id="item-bill-copy-feedback"></span> </div> </div>
        <div class="payment-plan section"> <h2>Oppgj√∏r og Betalingsplan (Kun Poker)</h2> <div class="action-buttons"> <button id="calculate-plan-btn" class="btn-success">Beregn Poker-Oppgj√∏r N√•</button> </div> <p>Resultat av poker-beregning:</p> <textarea id="payment-plan-output" class="output-area" readonly placeholder="Trykk 'Beregn Poker-Oppgj√∏r N√•'..."></textarea> <div style="text-align: right; margin-top: 5px;"> <button id="copy-plan-button" class="btn-primary" style="display: none;">Kopier Plan</button> <span id="plan-copy-feedback"></span> </div> <p id="control-sum-display" style="margin-top: 15px; font-style: italic; color: var(--text-muted-color); text-align: center;"></p> <p style="font-size: 0.9em; color: var(--text-muted-color); margin-top: 10px;"><i>NB: Inkluderer IKKE kostnader for mat/drikke.</i></p> </div>
        <div class="export-status section"> <h2>Eksporter Status (Backup)</h2> <div class="action-buttons"> <button id="generate-status-btn" class="btn-secondary">Generer Status for Kopiering</button> </div> <textarea id="status-output-area" class="output-area" readonly placeholder="Trykk 'Generer Status...'"></textarea> <div style="text-align: right; margin-top: 5px;"> <button id="copy-status-button" class="btn-primary" style="display: none;">Kopier Status</button> <span id="status-copy-feedback"></span> </div> <p style="font-size: 0.9em; color: var(--text-muted-color); margin-top: 10px;"><i>Inkluderer varekj√∏p. Lim inn i Excel, Sheets e.l.</i></p> </div>
        <div class="section data-info"> <h2>Viktig Informasjon om Datalagring</h2> <p>Appen lagrer data <strong>lokalt i din nettleser</strong> via <code>localStorage</code>.</p> <ul><li>Data er kun lagret i <strong>denne nettleseren</strong> p√• <strong>denne enheten</strong>.</li><li>Data deles <strong>ikke</strong> automatisk.</li><li><strong>RISIKO FOR DATATAP:</strong> Data slettes ved sletting av nettleserdata, feil, inkognitomodus etc.</li></ul> <p><strong>Backup:</strong> Bruk "Eksporter Status" regelmessig!</p> <p><strong>Permanent Sletting:</strong> Slett nettsteddata for denne siden i nettleserens innstillinger.</p> </div>
    </div>

    <dialog id="session-dialog">
        <button class="dialog-close-btn" onclick="this.closest('dialog').close()">√ó</button> <h2>Sesjonskontroller & Lagring</h2> <div class="game-controls-content"> <div class="input-group session-controls"> <label for="dialog-session-name">Sesjonsnavn:</label> <input type="text" id="dialog-session-name" placeholder="Navn p√• spillkveld"> </div> <div class="action-buttons-grouped" style="margin-bottom: 20px;"> <button id="dialog-save-game-btn" class="btn-success">Lagre / Oppdater Navn</button> <button id="dialog-new-session-btn" class="btn-warning">Start Ny Sesjon</button> </div> <div class="toggle-group"> <label for="toggle-timestamp-log">Loggf√∏r Tidspunkt:</label> <label class="toggle-switch"> <input type="checkbox" id="toggle-timestamp-log"> <span class="slider"></span> </label> </div> <hr style="border-color: var(--input-border); opacity: 0.5; margin: 20px 0;"> <div class="input-group session-load-area"> <label for="dialog-load-session-select">Lagrede Sesjoner:</label> <select id="dialog-load-session-select"><option value="">-- Velg sesjon --</option></select> </div> <div class="action-buttons-grouped"> <button id="dialog-load-selected-session-btn" class="btn-secondary" disabled>Last Valgt</button> <button id="dialog-delete-selected-session-btn" class="btn-danger" disabled>Slett Valgt</button> </div> <p id="session-timestamps" style="font-size: 0.8em; color: var(--text-muted-color); text-align: center; margin-top: 15px;"></p> <span id="dialog-save-feedback" style="display: block; margin-top: 10px; font-style: italic; text-align: center;"></span> </div>
    </dialog>
</div>

<script>
    // --- State ---
    let players = []; let items = []; let logTimestamps = false;
    const TOLERANCE = 0.01; const SESSIONS_STORAGE_KEY = 'pokerKassaProSessions_v2';
    let isSessionActive = false; let sessionStartedAt = null; let sessionUpdatedAt = null;
    let currentSessionKey = null; let currentSessionDisplayName = ""; let saveTimeout = null;

    // --- Hjelpefunksjoner ---
    function getNextItemId() { return items.reduce((max, i) => Math.max(max, i.id), -1) + 1; }
    function getNextPlayerId() { return players.reduce((max, p) => Math.max(max, p.id), -1) + 1; }
    function addDefaultItemsIfMissing() { const hasDrink = items.some(i => i.name.toLowerCase() === 'drikke'); const hasPizza = items.some(i => i.name.toLowerCase() === 'pizzastykke'); let itemsAdded = false; if (!hasDrink) { items.push({ id: getNextItemId(), name: "Drikke", price: 70 }); itemsAdded = true; } if (!hasPizza) { items.push({ id: getNextItemId(), name: "Pizzastykke", price: 30 }); itemsAdded = true; } return itemsAdded; }
    function formatTimestamp(isoString, includeSeconds = false) { if (!isoString) return ''; const date = new Date(isoString); const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }; if (includeSeconds) { options.second = '2-digit'; } return date.toLocaleString('no-NO', options); }

    // --- DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded START");

        // --- DOM Elementer ---
        const bodyElement = document.body; const openSessionDialogBtn = document.getElementById('open-session-dialog-btn'); const mainContentDiv = document.querySelector('.main-content'); const itemNameInput = document.getElementById('item-name'); const itemPriceInput = document.getElementById('item-price'); const addItemBtn = document.getElementById('add-item-btn'); const itemConfigListUl = document.querySelector('#item-config-list ul'); const playerNameInput = document.getElementById('player-name'); const initialBuyInInput = document.getElementById('initial-buy-in'); const addPlayerBtn = document.getElementById('add-player-btn'); const playersUl = document.getElementById('players'); const totalPlayerBuyInSpan = document.getElementById('total-player-buy-in'); const totalPlayerCashOutSpan = document.getElementById('total-player-cash-out'); const housePokerResultSpan = document.getElementById('house-poker-result'); const totalItemRevenueSpan = document.getElementById('total-item-revenue'); const biggestWinSpan = document.getElementById('biggest-win'); const biggestLossSpan = document.getElementById('biggest-loss'); const activePlayersCountSpan = document.getElementById('active-players-count'); const calculatePlanBtn = document.getElementById('calculate-plan-btn'); const paymentPlanOutput = document.getElementById('payment-plan-output'); const copyPlanButton = document.getElementById('copy-plan-button'); const planCopyFeedback = document.getElementById('plan-copy-feedback'); const controlSumDisplay = document.getElementById('control-sum-display'); const generateStatusBtn = document.getElementById('generate-status-btn'); const statusOutputArea = document.getElementById('status-output-area'); const copyStatusButton = document.getElementById('copy-status-button'); const statusCopyFeedback = document.getElementById('status-copy-feedback'); const generateItemBillBtn = document.getElementById('generate-item-bill-btn'); const itemBillOutput = document.getElementById('item-bill-output'); const copyItemBillBtn = document.getElementById('copy-item-bill-btn'); const itemBillCopyFeedback = document.getElementById('item-bill-copy-feedback'); const sessionDialog = document.getElementById('session-dialog'); const sessionNameInput = document.getElementById('dialog-session-name'); const saveGameBtn = document.getElementById('dialog-save-game-btn'); const newSessionBtn = document.getElementById('dialog-new-session-btn'); const loadSessionSelect = document.getElementById('dialog-load-session-select'); const loadSelectedSessionBtn = document.getElementById('dialog-load-selected-session-btn'); const deleteSelectedSessionBtn = document.getElementById('dialog-delete-selected-session-btn'); const saveFeedback = document.getElementById('dialog-save-feedback'); const toggleTimestampLog = document.getElementById('toggle-timestamp-log'); const sessionTimestampsP = document.getElementById('session-timestamps');
        console.log("DOM Elements obtained.");
        if (!openSessionDialogBtn) console.error("FATAL: openSessionDialogBtn element NOT FOUND during setup!"); if (!sessionDialog) console.error("FATAL: sessionDialog element NOT FOUND during setup!"); if (!playersUl) console.error("FATAL: playersUl element NOT FOUND during setup!"); if (!paymentPlanOutput) console.error("FATAL: paymentPlanOutput element NOT FOUND!"); if (!statusOutputArea) console.error("FATAL: statusOutputArea element NOT FOUND!"); if (!itemBillOutput) console.error("FATAL: itemBillOutput element NOT FOUND!");

        // --- Event Listeners (Med detaljert logging) ---
        if (openSessionDialogBtn) { openSessionDialogBtn.addEventListener('click', openSessionDialogHandler_OriginalLogic); console.log("ORIGINAL Event listener for openSessionDialogBtn ADDED."); } else { console.error("Could not attach listener to openSessionDialogBtn."); }
        if (addPlayerBtn) { addPlayerBtn.addEventListener('click', () => { console.log('Add Player button clicked. isSessionActive:', isSessionActive); handleAddPlayer(); }); } else { console.error("#add-player-btn not found"); } if (addItemBtn) { addItemBtn.addEventListener('click', () => { console.log('Add Item button clicked. isSessionActive:', isSessionActive); handleAddItem(); }); } else { console.error("#add-item-btn not found"); } if (newSessionBtn) newSessionBtn.addEventListener('click', handleStartNewSession); else console.error("#dialog-new-session-btn not found"); if (saveGameBtn) saveGameBtn.addEventListener('click', handleManualSaveOrUpdate); else console.error("#dialog-save-game-btn not found"); if (loadSelectedSessionBtn) loadSelectedSessionBtn.addEventListener('click', handleLoadSelectedSession); else console.error("#dialog-load-selected-session-btn not found"); if (deleteSelectedSessionBtn) deleteSelectedSessionBtn.addEventListener('click', handleDeleteSelectedSession); else console.error("#dialog-delete-selected-session-btn not found"); if (loadSessionSelect) loadSessionSelect.addEventListener('change', () => { const hasSelection = loadSessionSelect.value !== ""; loadSelectedSessionBtn.disabled = !hasSelection; deleteSelectedSessionBtn.disabled = !hasSelection; }); else console.error("#dialog-load-session-select not found"); if (calculatePlanBtn) calculatePlanBtn.addEventListener('click', () => { console.log("--- Calculate Plan button CLICKED ---"); calculateAndRenderPaymentPlan(); }); else console.error("#calculate-plan-btn not found"); if (copyPlanButton) copyPlanButton.addEventListener('click', copyPlanToClipboard); else console.error("#copy-plan-button not found"); if (generateStatusBtn) generateStatusBtn.addEventListener('click', () => { console.log("--- Generate Status button CLICKED ---"); generateAndDisplayStatusText(); }); else console.error("#generate-status-btn not found"); if (copyStatusButton) copyStatusButton.addEventListener('click', copyStatusTextToClipboard); else console.error("#copy-status-button not found"); if (generateItemBillBtn) generateItemBillBtn.addEventListener('click', () => { console.log("--- Generate Item Bill button CLICKED ---"); generateAndRenderItemBill(); }); else console.error("#generate-item-bill-btn not found"); if (copyItemBillBtn) copyItemBillBtn.addEventListener('click', copyItemBillToClipboard); else console.error("#copy-item-bill-btn not found"); if (itemConfigListUl) itemConfigListUl.addEventListener('click', (event) => { if (event.target.classList.contains('delete-item-btn')) { console.log("Delete Item button clicked"); const itemId = parseInt(event.target.dataset.itemId); deleteItem(itemId); } }); else console.error("#item-config-list ul not found"); if (initialBuyInInput) initialBuyInInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { console.log("Enter pressed on initial buy-in"); handleAddPlayer(); } }); else console.error("#initial-buy-in not found"); if (playerNameInput) playerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { console.log("Enter pressed on player name"); handleAddPlayer(); } }); else console.error("#player-name not found"); if (itemPriceInput) itemPriceInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { console.log("Enter pressed on item price"); handleAddItem(); } }); else console.error("#item-price not found"); if (itemNameInput) itemNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { console.log("Enter pressed on item name"); handleAddItem(); } }); else console.error("#item-name not found");
        if (playersUl) {
             playersUl.addEventListener('click', handlePlayerListClick); // Dekker n√• ogs√• logg-knapp
             playersUl.addEventListener('change', handlePokerInputChange); // H√•ndterer endring i input (f.eks. cashout)
             playersUl.addEventListener('blur', handlePokerInputChange, true); // H√•ndterer n√•r man forlater cashout-feltet
             playersUl.addEventListener('keypress', handlePokerInputKeypress); // H√•ndterer Enter i buy-in-feltet
             console.log("Event listeners for playersUl ADDED."); // Bekreft at de legges til
        } else { console.error("Could not attach listeners to playersUl."); }
        if (toggleTimestampLog) toggleTimestampLog.addEventListener('change', handleTimestampToggleChange); else console.error("#toggle-timestamp-log not found"); if (sessionNameInput) sessionNameInput.addEventListener('input', handleSessionNameInput); else console.error("#dialog-session-name not found");

        // --- UI Update Function ---
        function updateUIBasedOnSessionState() { console.log(`updateUIBasedOnSessionState called. isSessionActive: ${isSessionActive}`); if (!bodyElement || !openSessionDialogBtn || !saveGameBtn || !sessionTimestampsP || !toggleTimestampLog) { console.error("UI elements missing in updateUIBasedOnSessionState!"); return; } if (isSessionActive) { bodyElement.classList.add('session-active'); openSessionDialogBtn.textContent = 'Lagring/Sesjoner'; saveGameBtn.disabled = false; } else { bodyElement.classList.remove('session-active'); openSessionDialogBtn.textContent = 'Start / Last Sesjon'; saveGameBtn.disabled = true; } if (sessionTimestampsP) { if (isSessionActive && sessionStartedAt) { let text = `Startet: ${formatTimestamp(sessionStartedAt)}`; if (sessionUpdatedAt && sessionUpdatedAt !== sessionStartedAt) { text += ` | Sist lagret: ${formatTimestamp(sessionUpdatedAt, true)}`; } sessionTimestampsP.textContent = text; sessionTimestampsP.style.display = 'block'; } else { sessionTimestampsP.style.display = 'none'; } } toggleTimestampLog.disabled = !isSessionActive; }
        // --- Original Dialog Handler ---
         function openSessionDialogHandler_OriginalLogic() { console.log("openSessionDialogHandler_OriginalLogic started"); try { if (!sessionDialog) { console.error("FEIL: sessionDialog elementet ble ikke funnet!"); return; } if (!sessionNameInput || !toggleTimestampLog || !loadSessionSelect || !saveFeedback) { console.warn("En eller flere dialog-kontroller mangler."); } console.log("Setter verdier i dialog (original)..."); sessionNameInput.value = currentSessionDisplayName || ""; toggleTimestampLog.checked = logTimestamps; populateLoadDropdown(); console.log("populateLoadDropdown ferdig (original)."); saveFeedback.textContent = ''; updateUIBasedOnSessionState(); console.log("updateUIBasedOnSessionState ferdig i dialog-handler (original)."); console.log("Pr√∏ver √• kalle sessionDialog.showModal() (original)..."); sessionDialog.showModal(); console.log("sessionDialog.showModal() kalt (original)."); } catch (error) { console.error("FEIL inne i openSessionDialogHandler_OriginalLogic:", error); } }
        // --- Session Actions ---
        function handleStartNewSession() { console.log("handleStartNewSession started"); const nameToStart = sessionNameInput.value.trim(); if (!nameToStart) { alert("Skriv inn et navn for den nye sesjonen."); sessionNameInput.focus(); return; } if (isSessionActive) { if (!confirm("Starte en helt ny, tom sesjon? Den n√•v√¶rende sesjonen vil bli lagret (hvis den har navn) men du bytter til en ny.")) { return; } if (currentSessionDisplayName) { saveCurrentSession(false); } } players = []; items = []; logTimestamps = false; toggleTimestampLog.checked = false; sessionStartedAt = new Date().toISOString(); sessionUpdatedAt = sessionStartedAt; currentSessionKey = sessionStartedAt; currentSessionDisplayName = nameToStart; isSessionActive = true; console.log("isSessionActive satt til TRUE i handleStartNewSession"); addDefaultItemsIfMissing(); saveCurrentSession(true); renderApp(); updateUIBasedOnSessionState(); populateLoadDropdown(); clearAddPlayerForm(); itemNameInput.value = ''; itemPriceInput.value = ''; saveFeedback.textContent = `Ny sesjon "${currentSessionDisplayName}" startet og lagret.`; saveFeedback.style.color = 'var(--success-color)'; setTimeout(() => { saveFeedback.textContent = ''; }, 3000); sessionDialog.close(); console.log("handleStartNewSession finished"); }
        function handleLoadSelectedSession() { console.log("handleLoadSelectedSession started"); const selectedKey = loadSessionSelect.value; if (!selectedKey) { alert("Velg en sesjon √• laste."); return; } const sessions = getSavedSessions(); if (!sessions[selectedKey]) { alert(`Fant ikke data for sesjon startet ${formatTimestamp(selectedKey)}.`); populateLoadDropdown(); return; } const loadedState = sessions[selectedKey]; if (!loadedState || !loadedState.data || !loadedState.name || !loadedState.startedAt) { alert(`Ugyldig data funnet for sesjon startet ${formatTimestamp(selectedKey)}. Kan ikke laste.`); return; } if (isSessionActive) { if (!confirm(`Laste sesjon "${loadedState.name}"? Ul√•ste endringer i den n√•v√¶rende sesjonen ("${currentSessionDisplayName}") g√•r tapt hvis den ikke er lagret.`)) { return; } } players = loadedState.data.players || []; items = loadedState.data.items || []; logTimestamps = loadedState.data.logTimestamps || false; currentSessionKey = selectedKey; sessionStartedAt = loadedState.startedAt; sessionUpdatedAt = loadedState.updatedAt; currentSessionDisplayName = loadedState.name; isSessionActive = true; console.log("isSessionActive satt til TRUE i handleLoadSelectedSession"); players.forEach(p => { p.status = (p.cashout !== null && !isNaN(p.cashout)) ? 'cashed_out' : 'active'; p.purchases = p.purchases || {}; if (!Array.isArray(p.buyins)) { p.buyins = (typeof p.buyin === 'number' && p.buyin > 0) ? [p.buyin] : []; delete p.buyin; } p.transactionLog = p.transactionLog || []; }); addDefaultItemsIfMissing(); sessionNameInput.value = currentSessionDisplayName; toggleTimestampLog.checked = logTimestamps; renderApp(); updateUIBasedOnSessionState(); populateLoadDropdown(); saveFeedback.textContent = `Sesjon "${currentSessionDisplayName}" lastet.`; saveFeedback.style.color = 'var(--success-color)'; setTimeout(() => { saveFeedback.textContent = ''; }, 3000); sessionDialog.close(); console.log("handleLoadSelectedSession finished"); }
        function handleManualSaveOrUpdate() { if (!isSessionActive) { alert("Ingen aktiv sesjon √• lagre/oppdatere."); return; } const newName = sessionNameInput.value.trim(); if (!newName) { alert("Sesjonsnavn kan ikke v√¶re tomt."); sessionNameInput.focus(); return; } currentSessionDisplayName = newName; logTimestamps = toggleTimestampLog.checked; saveCurrentSession(true); sessionDialog.close(); }
        // --- Transaction Logging ---
        function logTransaction(playerId, type, details) { if (!logTimestamps || !isSessionActive) return; const playerIndex = players.findIndex(p => p.id === playerId); if (playerIndex === -1) return; if (!players[playerIndex].transactionLog) { players[playerIndex].transactionLog = []; } players[playerIndex].transactionLog.push({ ts: new Date().toISOString(), type: type, details: details }); }
        // --- Storage Functions ---
        function getSavedSessions() { const savedData = localStorage.getItem(SESSIONS_STORAGE_KEY); try { return savedData ? JSON.parse(savedData) : {}; } catch (e) { console.error("Error parsing saved sessions:", e); return {}; } }
        function saveSessions(sessions) { try { localStorage.setItem(SESSIONS_STORAGE_KEY, JSON.stringify(sessions)); return true; } catch (e) { console.error("Error saving sessions:", e); saveFeedback.textContent = 'FEIL: Kunne ikke lagre til localStorage.'; saveFeedback.style.color = 'var(--danger-color)'; return false; } }
        function populateLoadDropdown() { const sessions = getSavedSessions(); const sessionKeys = Object.keys(sessions).sort((a, b) => b.localeCompare(a)); loadSessionSelect.innerHTML = '<option value="">-- Velg sesjon --</option>'; sessionKeys.forEach(key => { const sessionData = sessions[key]; if (sessionData && sessionData.name && sessionData.startedAt) { const option = document.createElement('option'); option.value = key; option.textContent = `${sessionData.name} [${formatTimestamp(sessionData.startedAt)}]`; if (key === currentSessionKey) { option.selected = true; } loadSessionSelect.appendChild(option); } else { console.warn("Skipping invalid session data for key:", key); } }); const hasSelection = loadSessionSelect.value !== ""; loadSelectedSessionBtn.disabled = !hasSelection; deleteSelectedSessionBtn.disabled = !hasSelection; }
        function saveCurrentSession(showFeedback = false) { if (!isSessionActive || !currentSessionKey || !currentSessionDisplayName) { console.warn("Attempted to save without active session/key/name."); return; } const sessions = getSavedSessions(); sessionUpdatedAt = new Date().toISOString(); const currentGameState = { name: currentSessionDisplayName, startedAt: sessionStartedAt, updatedAt: sessionUpdatedAt, data: { players: players, items: items, logTimestamps: logTimestamps } }; sessions[currentSessionKey] = currentGameState; if (saveSessions(sessions)) { if (showFeedback) { saveFeedback.textContent = `Sesjon "${currentSessionDisplayName}" lagret.`; saveFeedback.style.color = 'var(--success-color)'; setTimeout(() => { saveFeedback.textContent = ''; }, 3000); } populateLoadDropdown(); updateUIBasedOnSessionState(); } }
        function handleDeleteSelectedSession() { const selectedKey = loadSessionSelect.value; if (!selectedKey) { alert("Velg sesjon for sletting."); return; } const sessions = getSavedSessions(); const sessionToDeleteName = sessions[selectedKey] ? sessions[selectedKey].name : `Ukjent [${formatTimestamp(selectedKey)}]`; if (!confirm(`Slette lagret sesjon "${sessionToDeleteName}"? Kan ikke angres.`)) { return; } if (sessions[selectedKey]) { delete sessions[selectedKey]; if (saveSessions(sessions)) { saveFeedback.textContent = `Sesjon "${sessionToDeleteName}" slettet.`; saveFeedback.style.color = 'var(--warning-color)'; if (selectedKey === currentSessionKey) { players = []; items = []; currentSessionKey = null; sessionStartedAt = null; sessionUpdatedAt = null; currentSessionDisplayName = ""; logTimestamps = false; toggleTimestampLog.checked = false; isSessionActive = false; sessionNameInput.value = ""; addDefaultItemsIfMissing(); renderApp(); updateUIBasedOnSessionState(); } populateLoadDropdown(); setTimeout(() => { saveFeedback.textContent = ''; }, 4000); } } else { alert(`Fant ikke sesjon startet ${formatTimestamp(selectedKey)} for sletting.`); populateLoadDropdown(); } }
        // --- Item Handling ---
        function handleAddItem() { console.log(`handleAddItem called. isSessionActive = ${isSessionActive}`); if (!isSessionActive) { console.warn("handleAddItem blocked: No active session."); return; } const name = itemNameInput.value.trim(); const priceRaw = itemPriceInput.value.trim(); const price = parseFloat(priceRaw); if (!name) { alert("Varenavn m√• fylles ut."); return; } if (priceRaw === '' || isNaN(price) || price < 0) { alert("Ugyldig pris."); return; } if (items.some(i => i.name.toLowerCase() === name.toLowerCase())) { alert(`Vare "${name}" finnes allerede.`); return; } items.push({ id: getNextItemId(), name, price }); itemNameInput.value = ''; itemPriceInput.value = ''; itemNameInput.focus(); renderApp(); requestSave(); }
        function deleteItem(itemId) { if (!isSessionActive) return; const itemToDelete = items.find(i => i.id === itemId); if (!itemToDelete) return; if (confirm(`Slette varen "${itemToDelete.name}"? Dette fjerner den ogs√• fra alle spilleres kj√∏p.`)) { items = items.filter(i => i.id !== itemId); players.forEach(p => { if (p.purchases && p.purchases[itemId]) { delete p.purchases[itemId]; logTransaction(p.id, 'item_delete', {itemName: itemToDelete.name}); } }); renderApp(); requestSave(); } }
        function renderItemConfigList() { itemConfigListUl.innerHTML = ''; if (items.length === 0) { itemConfigListUl.innerHTML = '<li>Ingen varer definert enn√•.</li>'; return; } items.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<span class="item-details">${item.name} - <span class="item-price">${item.price.toFixed(2)} kr</span></span><button class="btn-danger btn-tiny delete-item-btn" data-item-id="${item.id}">Slett</button>`; itemConfigListUl.appendChild(li); }); }
        // --- Player Handling ---
        function handleAddPlayer() { console.log(`handleAddPlayer called. isSessionActive = ${isSessionActive}`); if (!isSessionActive) { console.warn("handleAddPlayer blocked: No active session."); return; } const name = playerNameInput.value.trim(); const buyinRaw = initialBuyInInput.value.trim(); const initialBuyin = buyinRaw === '' ? 0 : parseFloat(buyinRaw); if (!name) { alert("Navn m√• fylles ut."); return; } if (buyinRaw !== '' && (isNaN(initialBuyin) || initialBuyin < 0)) { alert("Ugyldig innkj√∏pssum."); return; } if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) { alert(`Spiller "${name}" finnes allerede.`); return; } const newPlayerId = getNextPlayerId(); const newPlayer = { id: newPlayerId, name, buyins: initialBuyin > 0 ? [initialBuyin] : [], cashout: null, status: 'active', purchases: {}, transactionLog: [] }; players.push(newPlayer); console.log("Player pushed to array:", players); if (initialBuyin > 0) { logTransaction(newPlayerId, 'buyin_initial', { amount: initialBuyin }); } clearAddPlayerForm(); renderApp(); requestSave(); } // <<< clearAddPlayerForm ER N√Ö HER
        function clearAddPlayerForm() { console.log("clearAddPlayerForm CALLED"); if(playerNameInput) playerNameInput.value = ''; else console.error("playerNameInput missing in clearAddPlayerForm"); if(initialBuyInInput) initialBuyInInput.value = ''; else console.error("initialBuyInInput missing in clearAddPlayerForm"); if(playerNameInput) playerNameInput.focus(); else console.error("playerNameInput missing for focus in clearAddPlayerForm"); }
        function deletePlayer(id) { if (!isSessionActive) return; const playerToDelete = players.find(p => p.id === id); if (!playerToDelete) return; setTimeout(() => { if (confirm(`Slette ${playerToDelete.name}?`)) { players = players.filter(player => player.id !== id); renderApp(); requestSave(); } }, 0); }
        function handlePokerInputKeypress(event) { console.log("handlePokerInputKeypress triggered. Key:", event.key, "Target:", event.target, "Target classList:", event.target.classList); if (event.key === 'Enter' && event.target.classList.contains('inline-buyin-add')) { event.preventDefault(); const playerId = parseInt(event.target.dataset.playerId); console.log("Enter on buy-in field for player ID:", playerId); updateBuyIn(playerId, event.target); } } // La til classList log
        function handlePokerInputChange(event) { const target = event.target; console.log("handlePokerInputChange triggered. Type:", event.type, "Target:", target, "Target classList:", target.classList); if (target.classList.contains('inline-cashout')) { if (event.type === 'blur' || event.type === 'change') { const playerId = parseInt(target.dataset.playerId); console.log("Change/Blur on cashout field for player ID:", playerId); updateCashOut(playerId, target); } } } // La til classList log
        function updateBuyIn(playerId, inputElement) { console.log(`updateBuyIn START for player ${playerId}, value: '${inputElement.value}'`); if (!isSessionActive) { console.warn("updateBuyIn blocked: No active session."); return; } const playerIndex = players.findIndex(p => p.id === playerId); if (playerIndex === -1) return; const valueToAdd = parseFloat(inputElement.value); if (isNaN(valueToAdd) || valueToAdd <= 0) { console.log("updateBuyIn: Invalid value or <= 0"); if (inputElement.value.trim() !== '') {} inputElement.value = ''; return; } players[playerIndex].buyins = players[playerIndex].buyins || []; players[playerIndex].buyins.push(valueToAdd); logTransaction(playerId, 'buyin_add', { amount: valueToAdd }); inputElement.value = ''; console.log(`updateBuyIn: Added ${valueToAdd} for player ${playerId}`); renderApp(); requestSave(); }
        function updateCashOut(playerId, inputElement) { console.log(`updateCashOut START for player ${playerId}, value: '${inputElement.value}'`); if (!isSessionActive) { console.warn("updateCashOut blocked: No active session."); return; } const playerIndex = players.findIndex(p => p.id === playerId); if (playerIndex === -1) return; const oldCashout = players[playerIndex].cashout; const cashoutRaw = inputElement.value.trim(); const newCashout = cashoutRaw === '' ? null : parseFloat(cashoutRaw); if (cashoutRaw !== '' && (isNaN(newCashout) || newCashout < 0)) { alert("Ugyldig Uttak-sum."); inputElement.value = oldCashout !== null ? oldCashout.toFixed(2) : ''; return; } if (oldCashout !== newCashout) { players[playerIndex].cashout = newCashout; players[playerIndex].status = (newCashout !== null) ? 'cashed_out' : 'active'; const logType = newCashout === null ? 'cashout_clear' : 'cashout_set'; logTransaction(playerId, logType, { old: oldCashout, new: newCashout }); console.log(`updateCashOut: Updated to ${newCashout} for player ${playerId}`); renderApp(); requestSave(); } else { console.log("updateCashOut: No change in value."); } }
        function handlePlayerListClick(event) { console.log("handlePlayerListClick triggered. Target:", event.target, "Target classList:", event.target.classList); if (!isSessionActive) return; const target = event.target; const playerLi = target.closest('li.player-item'); if (!playerLi) { console.log("handlePlayerListClick: Click was not inside a player item."); return; } const playerId = parseInt(playerLi.dataset.playerId); console.log("handlePlayerListClick: Click inside player item ID:", playerId, "Target data-item-id:", target.dataset.itemId); if (target.classList.contains('delete-btn')) { console.log("-> Action: delete-btn"); deletePlayer(playerId); } else if (target.classList.contains('purchase-increment-btn')) { const itemId = parseInt(target.dataset.itemId); console.log("-> Action: purchase-increment-btn, Item ID:", itemId); changePurchaseQuantity(playerId, itemId, 1); } else if (target.classList.contains('purchase-decrement-btn')) { const itemId = parseInt(target.dataset.itemId); console.log("-> Action: purchase-decrement-btn, Item ID:", itemId); changePurchaseQuantity(playerId, itemId, -1); } else if (target.classList.contains('add-buyin-btn')) { console.log("-> Action: add-buyin-btn"); const buyinInputElement = playerLi.querySelector('.inline-buyin-add'); if (buyinInputElement) { updateBuyIn(playerId, buyinInputElement); } else { console.error("Buy-in input element not found for player", playerId);} } else if (target.classList.contains('toggle-log-btn')) { console.log("-> Action: toggle-log-btn"); togglePlayerLog(playerId, target); } else { console.log("-> Action: No specific button matched."); } } // La til classList log
        function changePurchaseQuantity(playerId, itemId, change) { console.log(`changePurchaseQuantity START for player ${playerId}, item ${itemId}, change ${change}`); if (!isSessionActive) { console.warn("changePurchaseQuantity blocked: No active session."); return; } const playerIndex = players.findIndex(p => p.id === playerId); if (playerIndex === -1) { console.log("Player not found."); return; } const item = items.find(i => i.id === itemId); if (!item) { console.log("Item not found."); return; } if (!players[playerIndex].purchases) { players[playerIndex].purchases = {}; } const currentQuantity = players[playerIndex].purchases[itemId] || 0; const newQuantity = currentQuantity + change; if (newQuantity < 0) { console.log("Cannot decrement below 0."); return; } if (newQuantity === 0) { delete players[playerIndex].purchases[itemId]; } else { players[playerIndex].purchases[itemId] = newQuantity; } logTransaction(playerId, 'item_change', { itemName: item.name, change: change > 0 ? `+${change}` : `${change}`, newQty: newQuantity }); console.log(`changePurchaseQuantity: Updated quantity to ${newQuantity}`); renderApp(); requestSave(); }
        function togglePlayerLog(playerId, buttonElement) { const logDiv = document.getElementById('log-' + playerId); if (logDiv) { logDiv.classList.toggle('visible'); buttonElement.textContent = logDiv.classList.contains('visible') ? 'Skjul Logg' : 'Vis Logg'; } }
        // --- Autosave Throttling ---
        function requestSave() { if (!isSessionActive) return; if (saveTimeout) { clearTimeout(saveTimeout); } const currentNameInInput = sessionNameInput.value.trim(); if (currentNameInInput && isSessionActive) { currentSessionDisplayName = currentNameInInput; } logTimestamps = toggleTimestampLog.checked; saveTimeout = setTimeout(() => { saveCurrentSession(false); saveTimeout = null; }, 1500); }
        // --- Dialog Input Handling ---
        function handleTimestampToggleChange(event) { if (!isSessionActive) return; logTimestamps = event.target.checked; requestSave(); renderApp(); }
        function handleSessionNameInput() { requestSave(); }
        // --- Rendering Functions ---
        function renderApp() { console.log("renderApp called"); renderItemConfigList(); renderPlayerList(); renderSummary(); clearCalculationResults(); }
        function clearCalculationResults() { /* ... uendret ... */ }
        function renderPlayerList() { console.log(`renderPlayerList START. isSessionActive: ${isSessionActive}, players count: ${players.length}`); if (!playersUl) { console.error("FEIL: playersUl element finnes ikke i renderPlayerList!"); return; } playersUl.innerHTML = ''; if (!isSessionActive) { console.log("renderPlayerList EXIT: Session not active."); return; } if (players.length === 0) { console.log("renderPlayerList: No players to render."); playersUl.innerHTML = '<li style="border: none; background: none; padding: 10px; text-align: center; color: var(--text-muted-color);">Legg til spillere over.</li>'; return; } const sortedPlayers = [...players].sort((a, b) => { if (a.status === 'active' && b.status !== 'active') return -1; if (a.status !== 'active' && b.status === 'active') return 1; return a.name.localeCompare(b.name); }); console.log(`renderPlayerList: Looping ${sortedPlayers.length} players.`); try { sortedPlayers.forEach((player, index) => { console.log(`renderPlayerList: Processing player ${index}: ${player.name} (ID: ${player.id})`); const li = document.createElement('li'); li.classList.add('player-item'); li.dataset.playerId = player.id; const totalBuyin = (player.buyins || []).reduce((sum, amount) => sum + amount, 0); const isCashedOut = player.status === 'cashed_out'; const result = isCashedOut ? ((player.cashout || 0) - totalBuyin) : null; const resultRounded = result !== null ? Math.round(result * 100) / 100 : null; let resultClass = 'neutral'; let resultText = '-'; let resultIcon = 'üòê'; if (resultRounded !== null) { if (Math.abs(resultRounded) < TOLERANCE) { resultClass = 'neutral'; resultText = `0.00 kr`; resultIcon='üòê';} else if (resultRounded > 0) { resultClass = 'win'; resultText = `+${resultRounded.toFixed(2)} kr`; resultIcon='üí∞'; } else { resultClass = 'loss'; resultText = `${resultRounded.toFixed(2)} kr`; resultIcon='üí∏'; } } const statusText = isCashedOut ? 'Ute' : 'Aktiv'; let buyinLogDetailsHTML = ''; if ((player.buyins || []).length > 1) { buyinLogDetailsHTML = `<div class="buyin-log-details">Detaljer: ${(player.buyins || []).map(b => b.toFixed(0)).join(' + ')}</div>`; } let purchasesHTML = ''; let totalPurchaseCost = 0; if (items.length > 0) { purchasesHTML += '<div class="player-purchases">'; items.forEach(item => { const quantity = player.purchases ? (player.purchases[item.id] || 0) : 0; if (quantity > 0) { totalPurchaseCost += quantity * item.price; } purchasesHTML += `<span class="purchase-item">${item.name}: <button class="btn-secondary btn-tiny purchase-decrement-btn" data-item-id="${item.id}">-</button> <span class="item-count">${quantity}</span> <button class="btn-secondary btn-tiny purchase-increment-btn" data-item-id="${item.id}">+</button></span>`; }); purchasesHTML += `<br><strong>Total Varekost: ${totalPurchaseCost.toFixed(2)} kr</strong></div>`; } else { purchasesHTML = '<div class="player-purchases" style="font-style: italic;">Ingen varer definert.</div>'; } let logContainerHTML = ''; if (logTimestamps) { let logEntriesHTML = ''; let logButtonHTML = ''; const hasLogEntries = player.transactionLog && player.transactionLog.length > 0; if (hasLogEntries) { logEntriesHTML = player.transactionLog.slice().reverse().map(log => { let detailsText = ''; if (log.type === 'buyin_initial' || log.type === 'buyin_add') detailsText = `+${log.details.amount.toFixed(2)} kr`; else if (log.type === 'cashout_set') detailsText = `Satt til ${log.details.new !== null ? log.details.new.toFixed(2) : 'null'} kr`; else if (log.type === 'cashout_clear') detailsText = `Fjernet uttak (fra ${log.details.old !== null ? log.details.old.toFixed(2) : 'null'} kr)`; else if (log.type === 'item_change') detailsText = `${log.details.itemName} (${log.details.change}, ny: ${log.details.newQty})`; else if (log.type === 'item_delete') detailsText = `Vare "${log.details.itemName}" slettet.`; const logTypeClass = log.type ? log.type.split('_')[0] : 'unknown'; return `<li><span class="log-time">[${formatTimestamp(log.ts, true)}]</span> <span class="log-type-${logTypeClass}">${log.type ? log.type.replace(/_/g,' ') : 'Ukjent'}:</span> ${detailsText}</li>`; }).join(''); } else { logEntriesHTML = `<li>Ingen loggf√∏rte hendelser.</li>`; } if(hasLogEntries) { logButtonHTML = `<button class="btn-secondary btn-tiny toggle-log-btn" data-player-id="${player.id}">Vis Logg</button>`; } logContainerHTML = `<div class="log-container"><div class="log-header"><h4>Logg:</h4>${logButtonHTML}</div><div class="transaction-log" id="log-${player.id}"><ul>${logEntriesHTML}</ul></div></div>`; } li.innerHTML = `<div class="player-header"><span class="player-name">${player.name} <span class="player-status-text ${player.status}">(${statusText})</span></span><button class="btn-danger btn-small delete-btn" data-id="${player.id}">Slett Spiller</button></div><div class="player-poker-controls"><div class="poker-control-group"><label>Total Innkj√∏p:</label><span class="current-total">${totalBuyin.toFixed(2)} kr</span></div><div class="poker-control-group"><label for="buyin-add-${player.id}">Legg til:</label><input type="number" class="inline-edit-input inline-buyin-add" id="buyin-add-${player.id}" data-player-id="${player.id}" placeholder="+ Sum" step="any"><button class="btn-tiny add-buyin-btn" title="Legg til innkj√∏p">+</button></div><div class="poker-control-group"><label for="cashout-${player.id}">Uttak:</label><input type="number" class="inline-edit-input inline-cashout" id="cashout-${player.id}" data-player-id="${player.id}" value="${player.cashout !== null ? player.cashout : ''}" placeholder="Sum ut" step="any"></div><div class="player-result result ${resultClass}">${resultIcon} ${resultText}</div></div>${buyinLogDetailsHTML}${purchasesHTML}${logContainerHTML}`; console.log(`renderPlayerList: innerHTML satt for ${player.name}. Pr√∏ver appendChild...`); playersUl.appendChild(li); console.log(`renderPlayerList: Appended player ${player.name} (ID: ${player.id}).`); }); } catch (error) { console.error("FEIL under spiller-loop i renderPlayerList:", error); } console.log(`renderPlayerList FINISHED.`); }
        function renderSummary() { console.log("renderSummary START. isSessionActive:", isSessionActive); if (!isSessionActive) return; try { /* ... resten av koden ... */ const cashedOutPlayers = players.filter(p => p.status === 'cashed_out'); const activePlayers = players.filter(p => p.status === 'active'); const totalPlayerBuyin = players.reduce((sum, p) => sum + (p.buyins || []).reduce((s, b) => s + b, 0), 0); const totalPlayerCashout = cashedOutPlayers.reduce((sum, p) => sum + (p.cashout || 0), 0); const housePokerResult = totalPlayerBuyin - totalPlayerCashout; totalPlayerBuyInSpan.textContent = totalPlayerBuyin.toFixed(2); totalPlayerCashOutSpan.textContent = totalPlayerCashout.toFixed(2); activePlayersCountSpan.textContent = activePlayers.length; housePokerResultSpan.textContent = `${housePokerResult.toFixed(2)} kr`; if (Math.abs(housePokerResult) < TOLERANCE) { housePokerResultSpan.className = 'highlight neutral-sum'; } else if (housePokerResult > 0) { housePokerResultSpan.className = 'highlight positive'; } else { housePokerResultSpan.className = 'highlight negative'; } let totalItemRevenue = 0; players.forEach(player => { if (player.purchases) { Object.keys(player.purchases).forEach(itemIdStr => { const itemId = parseInt(itemIdStr); const item = items.find(i => i.id === itemId); if (item) { const quantity = player.purchases[itemId] || 0; totalItemRevenue += quantity * item.price; } }); } }); totalItemRevenueSpan.textContent = totalItemRevenue.toFixed(2); let maxWin = 0; let winnerName = 'Ingen'; let maxLoss = 0; let loserName = 'Ingen'; cashedOutPlayers.forEach(p => { const playerTotalBuyin = (p.buyins || []).reduce((s, b) => s + b, 0); const result = (p.cashout || 0) - playerTotalBuyin; if (result > maxWin) { maxWin = result; winnerName = `${p.name} (+${maxWin.toFixed(2)} kr)`; } if (result < maxLoss) { maxLoss = result; loserName = `${p.name} (${maxLoss.toFixed(2)} kr)`; } }); biggestWinSpan.textContent = winnerName; biggestLossSpan.textContent = loserName; biggestWinSpan.className = winnerName !== 'Ingen' ? 'highlight positive' : 'highlight neutral-sum'; biggestLossSpan.className = loserName !== 'Ingen' ? 'highlight negative' : 'highlight neutral-sum'; } catch (error) { console.error("FEIL i renderSummary:", error);} }
        // --- Kalkuleringer (med try/catch rundt l√∏kker) ---
        function calculateAndRenderPaymentPlan() { console.log("calculateAndRenderPaymentPlan START. isSessionActive:", isSessionActive); if (!isSessionActive) { paymentPlanOutput.value = 'Start/last sesjon f√∏rst.'; return; } console.log("Output element:", paymentPlanOutput); try { const cashedOutPlayers = players.filter(p => p.status === 'cashed_out'); if (cashedOutPlayers.length === 0 && players.length > 0) { paymentPlanOutput.value = 'Ingen spillere har cashet ut (poker).'; copyPlanButton.style.display = 'none'; controlSumDisplay.textContent = ''; return; } if (players.length === 0) { paymentPlanOutput.value = 'Ingen spillere.'; copyPlanButton.style.display = 'none'; controlSumDisplay.textContent = ''; return; } const finalTotalBuyin = players.reduce((sum, p) => sum + (p.buyins || []).reduce((s, b) => s + b, 0), 0); const finalTotalCashout = cashedOutPlayers.reduce((sum, p) => sum + (p.cashout || 0), 0); const finalHouseResult = finalTotalBuyin - finalTotalCashout; const controlSum = finalTotalCashout - finalTotalBuyin + finalHouseResult; const isBalanced = Math.abs(controlSum) < TOLERANCE; controlSumDisplay.textContent = `Kontrollsum (Poker): ${controlSum.toFixed(2)} kr ${isBalanced ? '(OK)' : '(FEIL!)'}`; controlSumDisplay.style.color = isBalanced ? 'var(--success-color)' : 'var(--danger-color)'; if (!isBalanced) { paymentPlanOutput.value = 'FEIL: Poker-oppgj√∏ret er ikke balansert!'; copyPlanButton.style.display = 'none'; return; } let debtors = cashedOutPlayers .map(p => ({ name: p.name, amount: (p.buyins || []).reduce((s, b) => s + b, 0) - (p.cashout || 0) })) .filter(p => p.amount > TOLERANCE); let creditors = cashedOutPlayers .map(p => ({ name: p.name, amount: (p.cashout || 0) - (p.buyins || []).reduce((s, b) => s + b, 0) })) .filter(p => p.amount > TOLERANCE); if (finalHouseResult < -TOLERANCE) { debtors.push({ name: 'Huset', amount: Math.abs(finalHouseResult) }); } else if (finalHouseResult > TOLERANCE) { creditors.push({ name: 'Huset', amount: finalHouseResult }); } debtors.sort((a, b) => b.amount - a.amount); creditors.sort((a, b) => b.amount - a.amount); const transactions = []; let debtorIndex = 0; let creditorIndex = 0; while (debtorIndex < debtors.length && creditorIndex < creditors.length) { const debtor = debtors[debtorIndex]; const creditor = creditors[creditorIndex]; const transferAmount = Math.min(debtor.amount, creditor.amount); if (transferAmount > TOLERANCE) { const roundedTransferAmount = Math.round(transferAmount * 100) / 100; if (roundedTransferAmount > 0) { transactions.push({ from: debtor.name, to: creditor.name, amount: roundedTransferAmount }); debtor.amount -= transferAmount; creditor.amount -= transferAmount; } else { debtor.amount = 0; creditor.amount = 0; } } if (debtor.amount < TOLERANCE) debtorIndex++; if (creditor.amount < TOLERANCE) creditorIndex++; } if (transactions.length === 0) { paymentPlanOutput.value = 'Ingen poker-transaksjoner n√∏dvendig.'; copyPlanButton.style.display = 'none'; } else { let planText = `Poker Betalingsplan (${transactions.length} transaksjoner):\n\n`; try { transactions.forEach(t => { planText += `* ${t.from} vippser ${t.amount.toFixed(2)} kr til ${t.to}\n`; }); } catch(loopError){ console.error("Feil i transaksjons-loop:", loopError); planText += "\nFEIL I GENERERING AV PLAN."; } paymentPlanOutput.value = planText; copyPlanButton.style.display = 'inline-block'; } planCopyFeedback.textContent = ''; } catch (error) { console.error("FEIL i calculateAndRenderPaymentPlan:", error); paymentPlanOutput.value = "FEIL under beregning av betalingsplan."; } }
        function generateAndDisplayStatusText() { console.log("generateAndDisplayStatusText START. isSessionActive:", isSessionActive); if (!isSessionActive) { statusOutputArea.value = 'Start/last sesjon f√∏rst.'; return; } console.log("Output element:", statusOutputArea); try { if (players.length === 0 && items.length === 0) { statusOutputArea.value = "Ingen data √• eksportere."; copyStatusButton.style.display = 'none'; return; } let headers = ["Navn", "Total Innkj√∏p", "Uttak", "Status", "Poker Resultat"]; const itemHeaders = items.map(item => `${item.name} (Antall)`); headers = headers.concat(itemHeaders); headers.push("Total Varekost"); let statusText = headers.join("\t") + "\n"; try { players.forEach(p => { const totalBuyinFormatted = (p.buyins || []).reduce((s, b) => s + b, 0).toFixed(2); const cashoutFormatted = (p.cashout !== null && !isNaN(p.cashout)) ? p.cashout.toFixed(2) : ""; const statusTextPlayer = p.status === 'cashed_out' ? 'Ute' : 'Aktiv'; let pokerResultFormatted = ""; if (p.status === 'cashed_out') { pokerResultFormatted = ((p.cashout || 0) - parseFloat(totalBuyinFormatted)).toFixed(2); } let rowData = [ p.name, totalBuyinFormatted, cashoutFormatted, statusTextPlayer, pokerResultFormatted ]; let playerTotalPurchaseCost = 0; items.forEach(item => { const quantity = p.purchases ? (p.purchases[item.id] || 0) : 0; rowData.push(quantity.toString()); if (quantity > 0) { playerTotalPurchaseCost += item.price; } }); rowData.push(playerTotalPurchaseCost.toFixed(2)); statusText += rowData.join("\t") + "\n"; }); } catch(loopError){ console.error("Feil i spiller-loop (Status):", loopError); statusText += "\nFEIL UNDER GENERERING AV SPILLERDATA." } statusOutputArea.value = statusText; copyStatusButton.style.display = players.length > 0 ? 'inline-block' : 'none'; statusCopyFeedback.textContent = ''; } catch (error) { console.error("FEIL i generateAndDisplayStatusText:", error); statusOutputArea.value = "FEIL under generering av status."; } }
        function generateAndRenderItemBill() { console.log("generateAndRenderItemBill START. isSessionActive:", isSessionActive); if (!isSessionActive) { itemBillOutput.value = 'Start/last sesjon f√∏rst.'; return; } console.log("Output element:", itemBillOutput); try { let billText = "Oppgj√∏r for Mat & Drikke:\n\n"; let totalRevenueFromItems = 0; let playersWithPurchases = 0; try { players.forEach(player => { let playerTotalCost = 0; let playerPurchaseDetails = []; if (player.purchases && Object.keys(player.purchases).length > 0) { Object.entries(player.purchases).forEach(([itemIdStr, quantity]) => { const itemId = parseInt(itemIdStr); const item = items.find(i => i.id === itemId); if (item && quantity > 0) { playerTotalCost += quantity * item.price; playerPurchaseDetails.push(`${quantity} x ${item.name}`); } }); } if (playerTotalCost > 0) { playersWithPurchases++; billText += `* ${player.name}: ${playerPurchaseDetails.join(', ')} = ${playerTotalCost.toFixed(2)} kr\n`; totalRevenueFromItems += playerTotalCost; } }); } catch(loopError) { console.error("Feil i spiller-loop (ItemBill):", loopError); billText += "\nFEIL UNDER GENERERING AV VAREKJ√òP." } if (playersWithPurchases === 0) { billText += "Ingen varekj√∏p registrert."; copyItemBillBtn.style.display = 'none'; } else { billText += `\nTotal inntekt varesalg: ${totalRevenueFromItems.toFixed(2)} kr`; copyItemBillBtn.style.display = 'inline-block'; } itemBillOutput.value = billText; itemBillCopyFeedback.textContent = ''; } catch (error) { console.error("FEIL i generateAndRenderItemBill:", error); itemBillOutput.value = "FEIL under generering av vareoppgj√∏r."; } }
        // --- Kopi-funksjoner (uendret) ---
        function copyPlanToClipboard() { /* ... */ } function copyStatusTextToClipboard() { /* ... */ } function copyItemBillToClipboard() { /* ... */ }
        // --- Initial Load ---
        function initializeApp() { players = []; items = []; currentSessionKey = null; sessionStartedAt = null; sessionUpdatedAt = null; currentSessionDisplayName = ""; logTimestamps = false; isSessionActive = false; sessionNameInput.value = ""; toggleTimestampLog.checked = false; toggleTimestampLog.disabled = true; addDefaultItemsIfMissing(); renderApp(); updateUIBasedOnSessionState(); populateLoadDropdown(); console.log("initializeApp FINISHED."); }
        initializeApp();

    }); // END DOMContentLoaded
</script>

</body>
</html>
